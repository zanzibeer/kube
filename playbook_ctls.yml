---
- name : Install & run Containerd
  hosts: all
  become: yes
  gather_facts: no

  tasks:

  - name: Download crictl
    unarchive:
      src: 'https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.23.0/crictl-v1.23.0-linux-amd64.tar.gz'
      dest: /usr/bin
      remote_src: yes

  - name: Download nerdctl
    unarchive:
      src: 'https://github.com/containerd/nerdctl/releases/download/v0.16.1/nerdctl-0.16.1-linux-amd64.tar.gz'
      dest: /usr/bin
      remote_src: yes

  - name: Copy crictl config file
    copy:
      src: ./configs/crictl/crictl.yaml
      dest: /etc/
      mode: 0755
      owner: root
      group: root

  - name: Copy k8s.conf
    copy:
      src: ./configs/sysctl.d/k8s.conf
      dest: /etc/sysctl.d/
      mode: 0755
      owner: root
      group: root

  - name: Copy k8s.conf
    copy:
      src: ./configs/modules-load.d/k8s.conf
      dest: /etc/modules-load.d/
      mode: 0755
      owner: root
      group: root


  - name: Enable k8s.conf
    shell: 'sysctl --system'

  - name: Add gpg-key of Google repo
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

  - name: Add kubernetes repo
    apt_repository:
      repo: deb [arch=amd64] https://apt.kubernetes.io/ kubernetes-xenial main
      state: present


  - name: Install kubelet kubeadm kubectl
    apt:
      name:
      - kubelet
      - kubeadm
      - kubectl
      state: latest
      update_cache: yes
